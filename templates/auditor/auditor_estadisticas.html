{% extends base_template %}

{% load static %}

{% block title %}Estad√≠sticas - DataEasy{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/estadisticas.css' %}">
{% endblock %}

{% block content %}
<h2>üìä Estad√≠sticas del Inventario</h2>
<p>Visualiza el rendimiento y estado del inventario (solo lectura).</p>

<form method="GET" class="date-filter-form">
  <label for="fecha_inicio">Desde:</label>
  <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio|date:'Y-m-d' }}">
  <label for="fecha_fin">Hasta:</label>
  <input type="date" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin|date:'Y-m-d' }}">
  <button type="submit">üîç Filtrar</button>
</form>

<section class="stats-summary">
  <div class="stat-card"><h3>Total Productos</h3><div class="value">{{ total_productos }}</div></div>
  <div class="stat-card"><h3>Stock Total (Unidades)</h3><div class="value">{{ stock_total|default:"0" }}</div></div>
  <div class="stat-card"><h3>Total Categor√≠as</h3><div class="value">{{ total_categorias }}</div></div>
  <div class="stat-card"><h3>Total Marcas</h3><div class="value">{{ total_marcas }}</div></div>
  <div class="stat-card"><h3>Total Movimientos (Rango)</h3><div class="value">{{ total_movimientos }}</div></div>
</section>

<section class="charts-grid">
  <div class="chart-container">
    <h3>Movimientos por Mes</h3>
    <canvas id="movimientosMesChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>Stock por Categor√≠a</h3>
    <canvas id="stockCategoriaChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>Marcas con Stock Cr√≠tico</h3>
    <canvas id="stockCriticoMarcaChart"></canvas>
  </div>
</section>

<section class="low-stock-lists">
  <div class="stock-list-container">
    <h3>‚ö†Ô∏è Productos Bajo Stock M√≠nimo</h3>
    <ul>
      {% for prod in productos_bajo_stock %}
      <li>
        <span>{{ prod.nombre_producto }}</span>
        <span class="stock-level">({{ prod.stock_actual }}/{{ prod.stock_minimo }})</span>
      </li>
      {% empty %}
      <li>No hay productos bajo el m√≠nimo.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="stock-list-container">
    <h3>üö´ Productos Sin Stock</h3>
    <ul>
      {% for prod in productos_sin_stock %}
      <li><span>{{ prod.nombre_producto }}</span></li>
      {% empty %}
      <li>No hay productos sin stock.</li>
      {% endfor %}
    </ul>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartData = JSON.parse('{{ chart_data_json|escapejs }}');

  const commonChartOptions = { responsive: true, maintainAspectRatio: false };

  const ctxMov = document.getElementById('movimientosMesChart')?.getContext('2d');
  if (ctxMov && chartData.meses) {
    new Chart(ctxMov, {
      type: 'line',
      data: {
        labels: chartData.meses,
        datasets: [
          { label: 'Entradas', data: chartData.entradas, borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false },
          { label: 'Salidas', data: chartData.salidas, borderColor: 'rgb(255, 99, 132)', tension: 0.1, fill: false }
        ]
      },
      options: { ...commonChartOptions, scales: { y: { beginAtZero: true } } }
    });
  }

  const ctxCat = document.getElementById('stockCategoriaChart')?.getContext('2d');
  if (ctxCat && chartData.stock_por_categoria_labels) {
    new Chart(ctxCat, {
      type: 'pie',
      data: {
        labels: chartData.stock_por_categoria_labels,
        datasets: [{ label: 'Unidades en Stock', data: chartData.stock_por_categoria_values,
          backgroundColor: ['#3498DB','#E74C3C','#9B59B6','#F1C40F','#2ECC71','#1ABC9C','#E67E22','#BDC3C7','#7F8C8D','#34495E'],
          hoverOffset: 4
        }]
      },
      options: { ...commonChartOptions }
    });
  }

  const ctxCrit = document.getElementById('stockCriticoMarcaChart')?.getContext('2d');
  if (ctxCrit && chartData.stock_critico_marca_labels) {
    new Chart(ctxCrit, {
      type: 'bar',
      data: {
        labels: chartData.stock_critico_marca_labels,
        datasets: [{ label: 'N¬∫ Productos Cr√≠ticos', data: chartData.stock_critico_marca_values,
          backgroundColor: 'rgba(230, 126, 34, 0.6)', borderColor: 'rgba(230, 126, 34, 1)', borderWidth: 1
        }]
      },
      options: { ...commonChartOptions, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
  }
</script>
{% endblock %}
