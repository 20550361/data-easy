{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}DataEasy Auditor{% endblock %}</title>

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  {% block styles %}{% endblock %}
</head>
<body>

<header class="topbar">
  <a href="{% url 'auditor_home' %}" class="logo-link">
    <h1 class="logo">DataEasy</h1>
  </a>

  <div class="user-menu-wrapper">
    <img src="{% static 'img/user.png' %}" alt="Usuario" class="user-icon" id="userIcon">
    <div class="dropdown-menu" id="dropdownMenu">
      <a href="{% url 'auditor_perfil' %}">游 Mi ficha</a>
      <a href="#" id="logoutLink">游 Cerrar sesi칩n</a>

      <!-- Logout POST seguro -->
      <form id="logoutForm" action="{% url 'logout' %}" method="post" style="display:none;">
        {% csrf_token %}
      </form>
    </div>
  </div>
</header>

<div class="main-container">

  <aside class="sidebar" id="sidebar">
    <div class="profile-section">
      <div class="profile-pic-container">
        <img src="{% static 'img/user.png' %}" alt="Perfil" class="profile-pic">
      </div>
      <h3>{{ user.username }}</h3>
    </div>

    <nav class="sidebar-nav">
      <a href="{% url 'auditor_home' %}" class="sidebar-btn {% if request.resolver_match.url_name == 'auditor_home' %}active{% endif %}">
        游 Home
      </a>
      <a href="{% url 'auditor_perfil' %}" class="sidebar-btn {% if request.resolver_match.url_name == 'auditor_perfil' %}active{% endif %}">
        游 Mi ficha
      </a>
      <a href="{% url 'auditor_usuarios' %}" class="sidebar-btn {% if request.resolver_match.url_name == 'auditor_usuarios' %}active{% endif %}">
        游논 Gesti칩n de usuarios
      </a>
      <a href="{% url 'auditor_estadisticas' %}" class="sidebar-btn {% if request.resolver_match.url_name == 'auditor_estadisticas' %}active{% endif %}">
        游늵 Estad칤sticas
      </a>
      <a href="{% url 'auditor_carga_datos' %}" class="sidebar-btn {% if request.resolver_match.url_name == 'auditor_carga_datos' %}active{% endif %}">
        游닌 Carga de datos
      </a>

    </nav>
  </aside>

  <main class="content-area">

    {# ======= MENSAJES GLOBALES (FLASH) ======= #}
    {% if messages %}
      <div class="flash-container" aria-live="polite">
        {% for message in messages %}
          <div class="flash flash-{{ message.tags|default:'info' }}">
            <span class="flash-text">{{ message }}</span>
            <button type="button" class="flash-close" aria-label="Cerrar">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {# ========================================= #}

    {% block content %}{% endblock %}
  </main>

</div>

<script>
  // Men칰 usuario
  const userIcon = document.getElementById('userIcon');
  const dropdownMenu = document.getElementById('dropdownMenu');
  document.addEventListener('click', (e) => {
      if (userIcon && userIcon.contains(e.target)) {
          dropdownMenu.classList.toggle('show');
      } else if (dropdownMenu && !dropdownMenu.contains(e.target) && !userIcon.contains(e.target)) {
          dropdownMenu.classList.remove('show');
      }
  });

  // Logout POST
  const logoutLink = document.getElementById('logoutLink');
  const logoutForm = document.getElementById('logoutForm');
  if (logoutLink && logoutForm) {
      logoutLink.addEventListener('click', function (e) {
          e.preventDefault();
          logoutForm.submit();
      });
  }

  // Toastr simple (autocierre)
  (function () {
    const flashes = document.querySelectorAll('.flash');
    flashes.forEach((el) => {
      const btn = el.querySelector('.flash-close');
      if (btn) btn.addEventListener('click', () => el.remove());
      setTimeout(() => { if (el && el.parentNode) el.remove(); }, 5000);
    });
  })();
</script>

<style>
  .flash-container { margin: 0 0 16px 0; }
  .flash { position: relative; padding: 12px 40px 12px 14px; border-radius: 10px; margin-bottom: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,.05); }
  .flash .flash-close { position: absolute; right: 10px; top: 8px; border: none; background: transparent; font-size: 20px; line-height: 1; cursor: pointer; opacity: 0.6; }
  .flash .flash-close:hover { opacity: 1; }
  .flash-success { background: #e6ffed; color: #046c4e; border: 1px solid #a7f3d0; }
  .flash-error, .flash-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
  .flash-warning { background: #fef9c3; color: #92400e; border: 1px solid #fde68a; }
  .flash-info, .flash-debug { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
</style>

{% block scripts %}{% endblock %}
</body>
</html>
