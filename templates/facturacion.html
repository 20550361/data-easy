{% extends 'base.html' %}

{% block title %}Crear Movimiento{% endblock %}

{% block content %}

<h2>Crear Movimiento</h2>

<!-- =============================== -->
<!-- ========== DATOS CLIENTE ====== --> 
<!-- =============================== -->

<div class="card p-4 mb-4">

    <h4>Datos del Cliente</h4>

    <div class="row mt-3">

        <div class="col-md-4">
            <label>Nombre:</label>
            <input type="text" id="clienteNombre" class="form-control">
        </div>

        <div class="col-md-4">
            <label>Apellido:</label>
            <input type="text" id="clienteApellido" class="form-control">
        </div>

        <div class="col-md-4">
            <label>RUT:</label>
            <input type="text" id="clienteRut" class="form-control">
        </div>

    </div>

</div>


<!-- =============================== -->
<!-- ========== PRODUCTOS ========== -->
<!-- =============================== -->

<div class="card p-4">

    <h4>Productos</h4>

    <div class="row mt-3">

        <div class="col-md-6">
            <label>Seleccione un producto:</label>
            <select id="productoSelect" class="form-control">
                <option value="">-- Seleccionar producto --</option>
                {% for p in productos %}
                    <option value="{{ p.id }}">{{ p.nombre_producto }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label>Cantidad:</label>
            <input type="number" id="cantidadInput" class="form-control" min="1">
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="agregarProducto()">+ Agregar Producto</button>
        </div>

    </div>

    <!-- TABLA -->
    <table class="table mt-4">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Categoría</th>
                <th>Marca</th>
            </tr>
        </thead>

        <tbody id="tablaProductos"></tbody>
    </table>

    <button class="btn btn-primary mt-4 w-100" onclick="guardarFactura()">
        Guardar y generar PDF
    </button>

</div>


<!-- =============================== -->
<!-- ========== JAVASCRIPT ========= -->
<!-- =============================== -->

<script>

// LISTA INTERNA
let productosFactura = [];

// ===============================
// AGREGAR PRODUCTO A LA LISTA
// ===============================
function agregarProducto() {

    const select = document.getElementById("productoSelect");
    const productoId = select.value;
    const productoNombre = select.selectedOptions[0].text;
    const cantidad = parseInt(document.getElementById("cantidadInput").value);

    if (!productoId || cantidad <= 0) {
        alert("Debes seleccionar un producto y una cantidad válida.");
        return;
    }

    // Agregar al array que se enviará al backend
    productosFactura.push({
        id: productoId,
        cantidad: cantidad,
    });

    // Agregar a la tabla
    const tabla = document.getElementById("tablaProductos");
    const fila = document.createElement("tr");

    fila.innerHTML = `
        <td>${productoNombre}</td>
        <td>${cantidad}</td>
        <td>N/A</td>
        <td>N/A</td>
    `;

    tabla.appendChild(fila);
}
// ===============================
// ENVIAR FACTURA AL BACKEND
// ===============================
async function guardarFactura() {

    const nombre = document.getElementById("clienteNombre").value;
    const apellido = document.getElementById("clienteApellido").value;
    const rut = document.getElementById("clienteRut").value;

    if (!nombre || !apellido || !rut) {
        alert("Debe completar todos los datos del cliente.");
        return;
    }

    if (productosFactura.length === 0) {
        alert("Debe agregar al menos un producto.");
        return;
    }

    const payload = {
        cliente_nombre: nombre,
        cliente_apellido: apellido,
        cliente_rut: rut,
        items: productosFactura,
    };

    const response = await fetch("/facturacion/registrar/", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (data.status === "ok") {
        alert("Factura registrada correctamente.");
        window.location.href = `/facturacion/pdf/${data.factura_id}/`;
    } else {
        alert("Error al guardar la factura.");
    }
}


// ===============================
// OBTENER TOKEN CSRF
// ===============================
function getCSRFToken() {
    return document.cookie.split("; ")
        .find(row => row.startsWith("csrftoken="))
        ?.split("=")[1];
}

</script>

{% endblock %}
