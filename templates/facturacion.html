{% extends 'base.html' %}

{% block title %}Crear Movimiento{% endblock %}

{% block content %}

<h2>Crear Movimiento</h2>

<!-- =============================== -->
<!-- ========== DATOS CLIENTE ====== --> 
<!-- =============================== -->

<div class="card p-4 mb-4">

    <h4>Datos del Cliente</h4>

    <div class="row mt-3">

        <div class="col-md-4">
            <label>Nombre:</label>
            <input type="text" id="clienteNombre" class="form-control">
        </div>

        <div class="col-md-4">
            <label>Apellido:</label>
            <input type="text" id="clienteApellido" class="form-control">
        </div>

        <div class="col-md-4">
            <label>RUT:</label>
            <input 
                type="text" 
                id="cliente_rut" 
                class="form-control"
                placeholder="Ej: 12345678-9"
                maxlength="12"
                oninput="this.value = this.value.replace(/[^0-9kK\-]/g, '')"/>
        </div>

    </div>

</div>


<!-- =============================== -->
<!-- ========== PRODUCTOS ========== -->
<!-- =============================== -->

<div class="card p-4">

    <h4>Productos</h4>

    <div class="row mt-3">

        <div class="col-md-6">
            <label>Seleccione un producto:</label>
            <select id="productoSelect" class="form-control">
                <option value="">-- Seleccionar producto --</option>
                {% for p in productos %}
                    <option value="{{ p.id }}">{{ p.nombre_producto }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label>Cantidad:</label>
            <input type="number" id="cantidadInput" class="form-control" min="1">
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="agregarProducto()">+ Agregar Producto</button>
        </div>

    </div>

    <!-- TABLA -->
    <table class="table mt-4">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Categor√≠a</th>
                <th>Marca</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>

        <tbody id="tablaProductos"></tbody>
    </table>

    <button class="btn btn-primary mt-4 w-100" onclick="guardarFactura()">
        Guardar y generar PDF
    </button>

</div>


<!-- =============================== -->
<!-- ========== JAVASCRIPT ========= -->
<!-- =============================== -->

<script>
// LISTA INTERNA que almacena los productos a facturar
let productosFactura = [];

// Cargar datos de productos desde el JSON pasado por Django
// Este objeto nos permite buscar categor√≠a y marca por ID de producto
let productosData = JSON.parse('{{ productos_json|safe }}');
let productosMap = {};
productosData.forEach(p => {
    productosMap[p.id] = p;
});

// ===============================
// MOSTRAR MODAL DE ERROR
// ===============================
// Funci√≥n para mostrar errores en un modal de Bootstrap
function mostrarError(titulo, mensaje) {
    const modal = new bootstrap.Modal(document.getElementById('modalError'), {
        backdrop: 'static',
        keyboard: false
    });
    document.getElementById('errorTitulo').textContent = titulo;
    document.getElementById('errorMensaje').textContent = mensaje;
    modal.show();
}

// ===============================
// AGREGAR PRODUCTO A LA LISTA
// ===============================
// Agrega un producto a la tabla y al array de productos
function agregarProducto() {
    const select = document.getElementById("productoSelect");
    const productoId = select.value;
    const cantidad = parseInt(document.getElementById("cantidadInput").value);

    // VALIDACI√ìN: Verificar que se seleccion√≥ producto y cantidad v√°lida
    if (!productoId || cantidad <= 0) {
        mostrarError("Validaci√≥n", "Debes seleccionar un producto y una cantidad v√°lida.");
        return;
    }

    // Obtener datos del producto desde el mapa (incluye categor√≠a y marca)
    const producto = productosMap[productoId];
    if (!producto) {
        mostrarError("Error", "Producto no encontrado.");
        return;
    }

    // Agregar al array interno (esto se enviar√° al backend)
    productosFactura.push({
        id: productoId,
        cantidad: cantidad,
        nombre: producto.nombre,
        categoria: producto.categoria,
        marca: producto.marca
    });

    // Agregar fila a la tabla con bot√≥n de eliminar
    const tabla = document.getElementById("tablaProductos");
    const fila = document.createElement("tr");
    const indice = productosFactura.length - 1; // √çndice del producto agregado

    fila.innerHTML = `
        <td>${producto.nombre}</td>
        <td>${cantidad}</td>
        <td>${producto.categoria}</td>
        <td>${producto.marca}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${indice})">
                üóëÔ∏è Eliminar
            </button>
        </td>
    `;

    tabla.appendChild(fila);
    
    // Limpiar campos de entrada para agregar otro producto
    document.getElementById("productoSelect").value = "";
    document.getElementById("cantidadInput").value = "";
}

// ===============================
// ELIMINAR PRODUCTO DE LA LISTA
// ===============================
// Elimina un producto de la tabla y del array
function eliminarProducto(indice) {
    // Eliminar del array interno
    productosFactura.splice(indice, 1);
    
    // Eliminar fila de la tabla
    const tabla = document.getElementById("tablaProductos");
    const filas = tabla.querySelectorAll("tr");
    if (filas[indice]) {
        filas[indice].remove();
    }
}

// ===============================
// ENVIAR FACTURA AL BACKEND
// ===============================
// Valida datos del cliente y crea la factura
async function guardarFactura() {
    const nombre = document.getElementById("clienteNombre").value;
    const apellido = document.getElementById("clienteApellido").value;
    const rut = document.getElementById("cliente_rut").value;

    // VALIDACI√ìN 1: Completar datos del cliente
    if (!nombre || !apellido || !rut) {
        mostrarError("Datos incompletos", "Debe completar todos los datos del cliente.");
        return;
    }

    // VALIDACI√ìN 2: RUT v√°lido
    if (!validarRUT(rut)) {
        mostrarError("RUT Inv√°lido", "El RUT ingresado no es v√°lido. Verifique e intente nuevamente.");
        return;
    }

    // VALIDACI√ìN 3: Agregar al menos un producto
    if (productosFactura.length === 0) {
        mostrarError("Sin productos", "Debe agregar al menos un producto a la factura.");
        return;
    }

    // Construir payload con datos de cliente e items
    // Solo enviamos id y cantidad al backend (no nombre, categor√≠a, marca)
    const payload = {
        cliente_nombre: nombre,
        cliente_apellido: apellido,
        cliente_rut: rut,
        items: productosFactura.map(p => ({ id: p.id, cantidad: p.cantidad }))
    };

    // Enviar al backend
    const response = await fetch("/facturacion/registrar/", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(payload)
    });

    const data = await response.json();

    // Procesar respuesta
    if (data.status === "ok") {
        // √âxito: redirigir a generar PDF
        mostrarError("√âxito", "Factura registrada correctamente. Se generar√° el PDF...");
        setTimeout(() => {
            window.location.href = `/facturacion/pdf/${data.factura_id}/`;
        }, 1500);
    } else {
        // Error: mostrar mensaje del servidor
        mostrarError("Error", data.message || "No se pudo guardar la factura.");
    }
}

// ===============================
// OBTENER TOKEN CSRF
// ===============================
// Extrae el token CSRF de las cookies
function getCSRFToken() {
    return document.cookie.split("; ")
        .find(row => row.startsWith("csrftoken="))
        ?.split("=")[1];
}

// ===============================
// VALIDAR RUT CHILENO
// ===============================
// Valida formato y d√≠gito verificador del RUT
function validarRUT(rut) {
    rut = rut.replace(/\./g, "").replace(/-/g, "");

    if (rut.length < 8) return false;

    let cuerpo = rut.slice(0, -1);
    let dv = rut.slice(-1).toUpperCase();

    let suma = 0;
    let multiplo = 2;

    // Calcular d√≠gito verificador
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += multiplo * cuerpo[i];
        multiplo = multiplo === 7 ? 2 : multiplo + 1;
    }

    let dvEsperado = 11 - (suma % 11);
    dvEsperado = dvEsperado === 11 ? "0" : dvEsperado === 10 ? "K" : dvEsperado.toString();

    return dv === dvEsperado;
}

</script>

<!-- =============================== -->
<!-- MODAL DE ERROR (Bootstrap) -->
<!-- =============================== -->
<div class="modal fade" id="modalError" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorTitulo">Error</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="errorMensaje">Mensaje de error</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
