{% extends 'base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Usuarios - DataEasy{% endblock %}

{% block styles %}
<style>
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
    .badge-admin { background-color: #f8d7da; color: #721c24; }
    .badge-staff { background-color: #fff3cd; color: #856404; }
    .badge-user { background-color: #e2e3e5; color: #383d41; }

    .btn-primary, .btn-edit, .btn-delete {
        display: inline-block;
        padding: 8px 14px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: 0.2s ;
        border: none;
        cursor: pointer;
    }
    .btn-primary { background: #2C3E50; color: #fff; }
    .btn-edit { background: #3498DB; color: #fff; margin-right: 6px; }
    .btn-delete { background: #E74C3C; color: #fff; }
    .btn-edit:hover { background: #217dbb; }
    .btn-delete:hover { background: #c0392b; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<h2>üë• Gesti√≥n de Usuarios</h2>
<p>Administra las cuentas y permisos de los usuarios del sistema.</p>

<div class="toolbar">
    <a href="{% url 'usuario_crear' %}" class="btn-primary">‚ûï Crear Nuevo Usuario</a>
</div>

<table>
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Miembro desde</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for usuario in lista_usuarios %}
        <tr>
            <td>{{ usuario.username }}</td>
            <td>{{ usuario.email|default:"(Obligatorio)" }}</td>

            <td>
                {% if usuario.is_superuser %}
                    <span class="badge badge-admin">Super Admin</span>
                {% elif usuario.is_staff %}
                    <span class="badge badge-staff">Staff</span>
                {% else %}
                    <span class="badge badge-user">Usuario</span>
                {% endif %}
            </td>

            <td>
                {% if usuario.is_active %}
                    ‚úî Activo
                {% else %}
                    ‚ùå Inactivo
                {% endif %}
            </td>

            <td>{{ usuario.date_joined|date:"d M Y" }}</td>

            <td>
                <a href="{% url 'usuario_editar' usuario.id %}" class="btn-edit">‚úèÔ∏è Editar</a>

                {% if not usuario.is_superuser %}
                    <!-- Bot√≥n Trigger del Modal -->
                    <button type="button" 
                            class="btn-delete" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteUserModal"
                            data-username="{{ usuario.username }}"
                            data-url="{% url 'usuario_eliminar' usuario.id %}">
                        üóëÔ∏è Eliminar
                    </button>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- ========================================== -->
<!-- MODAL DE CONFIRMACI√ìN DE ELIMINAR (POP-UP) -->
<!-- ========================================== -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Encabezado Oscuro para destacar -->
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body p-4">
        <p class="mb-0">¬øEst√°s seguro de que deseas eliminar al usuario <strong id="modal-user-name"></strong>?</p>
        <p class="text-muted small mt-2">Esta acci√≥n no se puede deshacer.</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        
        <!-- Formulario que realizar√° la acci√≥n real -->
        <form id="deleteUserForm" method="post" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Aceptar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Script para pasar datos al modal -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    var deleteUserModal = document.getElementById('deleteUserModal');
    
    deleteUserModal.addEventListener('show.bs.modal', function (event) {
        // Bot√≥n que activ√≥ el modal
        var button = event.relatedTarget;
        
        // Extraer info de los atributos data-*
        var username = button.getAttribute('data-username');
        var url = button.getAttribute('data-url');
        
        // Actualizar el contenido del modal
        var modalUserName = deleteUserModal.querySelector('#modal-user-name');
        var modalForm = deleteUserModal.querySelector('#deleteUserForm');
        
        modalUserName.textContent = username;
        modalForm.action = url;
    });
});
</script>

{% endblock %}