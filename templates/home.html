{% extends 'base.html' %}
{% load static %}

{% block title %}Home - DataEasy{% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/home-style.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}


{% block content %}
    <section class="welcome-banner">
        <h2>Bienvenido, {{ user.username }}</h2>
        <p>Este es tu panel principal en DataEasy</p>
    </section>

    <section class="dashboard-panels">
        <div class="recent-items">
            <h3>Últimos movimientos</h3>
            <ul>
                {% for mov in movimientos_recientes %}
                    <li>
                        <strong>{{ mov.tipo_movimiento|capfirst }}</strong>: 
                        {{ mov.cantidad }} x {{ mov.producto.nombre_producto }}
                        <span class="fecha">{{ mov.fecha_movimiento|date:"d M Y" }}</span>
                    </li>
                {% empty %}
                    <p>No hay movimientos recientes.</p>
                {% endfor %}
            </ul>
        </div>

        <div class="low-stock">
            <h3>⚠️ Artículos con bajo stock</h3>
            <ul>
                {% for prod in productos_bajo_stock %}
                    <li>
                        <a href="{% url 'inventario_editar' prod.id %}"> 
                            {{ prod.nombre_producto }}
                            <span class="stock-level">
                                Quedan: {{ prod.stock_actual }} (Min: {{ prod.stock_minimo }})
                            </span>
                        </a>
                    </li>
                {% empty %}
                    <p>No hay productos en alerta.</p>
                {% endfor %}
            </ul>
        </div>
    </section>


<!-- ===================== NUEVO: BLOQUE INVENTARIO (estilo video) ===================== -->
<section class="card inv-header">
  <div class="title-wrap">
    <h2>Control de Inventario</h2>
    <p>Estado general de productos y existencias</p>
  </div>

  <div class="actions">
    <!-- No cambiamos tu flujo: este “Actualizar Stock” simplemente recarga la página -->
    <a href="{% url 'home' %}" class="btn btn-primary">Actualizar Stock</a>

    <!-- Exportar CSV respeta ?solo_alertas=1 si está activo -->
    <a href="{% url 'home_export_csv' %}{% if solo_alertas %}?solo_alertas=1{% endif %}" class="btn btn-success">
      Exportar CSV
    </a>

    <!-- Botón conmutador: 'Solo alertas' / 'Ver todo' sin borrar nada -->
    {% if solo_alertas %}
      <a href="{% url 'home' %}" class="btn btn-warning">Ver Todo</a>
    {% else %}
      <a href="?solo_alertas=1" class="btn btn-warning">Solo Alertas</a>
    {% endif %}
  </div>
</section>

<section class="card inv-table">
  <div class="subheader">
    <h3>Stock Actual</h3>
    <span class="muted">
      {{ productos.count }} productos listados
      {% if solo_alertas %} · mostrando <strong>solo alertas</strong>{% endif %}
    </span>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Marca</th>
          <th>Stock Mín.</th>
          <th>Stock Actual</th>
          <th>Estado</th>
          <th class="acciones">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
          {# Colores por estado: rojo = sin stock, amarillo = bajo, verde = normal #}
          <tr class="
            {% if p.stock_actual|default:0 == 0 %}row-danger
            {% elif p.stock_actual|default:0 <= p.stock_minimo %}row-warning
            {% else %}row-ok{% endif %}
          >
            <td class="code">PRD-{{ p.id|stringformat:"04d" }}</td>
            <td class="name">{{ p.nombre_producto }}</td>
            <td>{{ p.categoria.nombre_categoria|default:"—" }}</td>
            <td>{{ p.marca.nombre_marca|default:"—" }}</td>
            <td>{{ p.stock_minimo }}</td>
            <td>{{ p.stock_actual|default:"0" }}</td>
            <td>
              {% if p.stock_actual|default:0 == 0 %}
                <span class="badge danger">Sin Stock</span>
              {% elif p.stock_actual|default:0 <= p.stock_minimo %}
                <span class="badge warn">Stock Bajo</span>
              {% else %}
                <span class="badge ok">Normal</span>
              {% endif %}
            </td>
            <td class="acciones">
              <a class="btn btn-teal" href="{% url 'inventario_editar' p.id %}">Ver</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8" class="empty">No hay productos para mostrar.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<!-- =================== /NUEVO BLOQUE INVENTARIO =================== -->
 {% endblock %}