{% extends 'base.html' %}
{% load static %}

{% block title %}Inicio - DataEasy{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>
/* --- CSS PARA EL FILTRO DE FECHAS --- */
.filtro-fechas {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    background: #ffffffdd;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e5e7eb;
    flex-wrap: wrap;
}
.filtro-fechas label {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 3px;
}
.filtro-fechas input[type="date"] {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
.filtro-fechas .btn {
    height: 38px;
}
</style>
{% endblock %}

{% block content %}

<!-- ENCABEZADO -->
<div class="home-header">
  <h2 class="home-title">Hola, {{ request.user.first_name|default:request.user.username }} üëã</h2>
  <p class="home-subtitle">Dashboard resumido del inventario</p>
</div>

<!-- FILTRO DE FECHAS -->
<form method="get" class="filtro-fechas">

    <div>
        <label>Desde</label>
        <input type="date" name="fecha_inicio"
               value="{{ fecha_inicio|date:'Y-m-d' }}">
    </div>

    <div>
        <label>Hasta</label>
        <input type="date" name="fecha_fin"
               value="{{ fecha_fin|date:'Y-m-d' }}">
    </div>

    <button type="submit" class="btn btn-primary">Filtrar</button>

    {% if request.GET.fecha_inicio or request.GET.fecha_fin %}
    <a href="{% url 'home' %}" class="btn btn-outline-secondary">‚ùå Limpiar</a>
    {% endif %}
</form>

<!-- ALERTA FLOTANTE -->
{% if productos_bajo_stock or productos_sin_stock %}
<div id="alerta-stock-home" class="alerta-stock-home alerta-stock">
    <h5>‚ö† Productos con problemas de stock</h5>

    <ul class="alerta-stock-list">
        {% for p in productos_sin_stock %}
        <li>üî¥ 
            <a href="{% url 'inventario_lista' %}?q={{ p.nombre_producto }}">
                {{ p.nombre_producto }}
            </a> ‚Äî Sin stock
        </li>
        {% endfor %}
        {% for p in productos_bajo_stock %}
        <li>üü° 
            <a href="{% url 'inventario_lista' %}?q={{ p.nombre_producto }}">
                {{ p.nombre_producto }}
            </a> ({{ p.stock_actual }}/{{ p.stock_minimo }})
        </li>
        {% endfor %}
    </ul>

    <div class="alerta-stock-footer">
        <a href="{% url 'inventario_lista' %}?solo_alertas=1" class="alerta-stock-link">
            Ver en inventario
        </a>
    </div>
</div>
{% endif %}

<!-- TARJETAS -->
<section class="stats-summary">
    <div class="stat-card"><h3>Total Productos</h3><div class="value">{{ total_productos }}</div></div>
    <div class="stat-card"><h3>Stock Total</h3><div class="value">{{ stock_total }}</div></div>
    <div class="stat-card"><h3>Categor√≠as</h3><div class="value">{{ total_categorias }}</div></div>
    <div class="stat-card"><h3>Marcas</h3><div class="value">{{ total_marcas }}</div></div>
</section>

<!-- GR√ÅFICOS -->
<section class="charts-grid">

    <!-- MOVIMIENTOS -->
    <div class="chart-container small-chart">
        <h3>Movimientos</h3>
        <canvas id="movimientosMesChart"></canvas>
    </div>

    <!-- PIE -->
    <div class="chart-container small-chart">
        <h3>Categor√≠as</h3>
        <canvas id="stockCategoriaChart"></canvas>
    </div>

    <!-- STOCK CR√çTICO -->
    <div class="chart-container small-chart">
        <h3>Stock Cr√≠tico</h3>
        <canvas id="stockCriticoMarcaChart"></canvas>
    </div>

</section>

<!-- LISTAS -->
<section class="low-stock-lists">
    <div class="stock-list-container">
        <h3>üü° Bajo Stock</h3>
        <ul>
            {% for prod in productos_bajo_stock %}
            <li>{{ prod.nombre_producto }} ({{ prod.stock_actual }}/{{ prod.stock_minimo }})</li>
            {% empty %}
            <li>No hay productos bajo m√≠nimo.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="stock-list-container">
        <h3>üî¥ Sin Stock</h3>
        <ul>
            {% for prod in productos_sin_stock %}
            <li>{{ prod.nombre_producto }}</li>
            {% empty %}
            <li>No hay productos sin stock.</li>
            {% endfor %}
        </ul>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===========================================
   ALERTA FLOTANTE DRAG
===========================================*/
document.addEventListener("DOMContentLoaded", () => {
    const box = document.getElementById("alerta-stock-home");
    if (!box) return;

    let mov = false, offsetX = 0, offsetY = 0;

    box.addEventListener("mousedown", e => {
        mov = true;
        offsetX = e.clientX - box.getBoundingClientRect().left;
        offsetY = e.clientY - box.getBoundingClientRect().top;
        box.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", e => {
        if (!mov) return;

        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;

        const maxX = window.innerWidth - box.offsetWidth - 10;
        const maxY = window.innerHeight - box.offsetHeight - 10;

        x = Math.min(Math.max(x, 10), maxX);
        y = Math.min(Math.max(y, 70), maxY);

        box.style.left = x + "px";
        box.style.top = y + "px";
    });

    document.addEventListener("mouseup", () => mov = false);
});

/* ===========================================
   DATOS CHARTS
===========================================*/
const data = JSON.parse(`{{ chart_data_json|escapejs }}`);

/* MOVIMIENTOS ‚Äî L√≠nea compacta */
new Chart(document.getElementById('movimientosMesChart'), {
    type: 'line',
    data: {
        labels: data.meses,
        datasets: [
            { label: 'Entradas', data: data.entradas, borderColor: '#4e79a7', borderWidth: 2 },
            { label: 'Salidas', data: data.salidas, borderColor: '#e15759', borderWidth: 2 }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { left: 20, right: 20 } },
        elements: { point: { radius: 3 } }
    }
});

/* PIE */
new Chart(document.getElementById('stockCategoriaChart'), {
    type: 'doughnut',
    data: {
        labels: data.stock_por_categoria_labels,
        datasets: [{
            data: data.stock_por_categoria_values,
            backgroundColor: [
                '#4e79a7','#f28e2b','#e15759','#76b7b2',
                '#59a14f','#edc948','#b07aa1','#ff9da7'
            ]
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

/* STOCK CR√çTICO ‚Äî Barras delgadas */
new Chart(document.getElementById('stockCriticoMarcaChart'), {
    type: 'bar',
    data: {
        labels: data.stock_critico_marca_labels,
        datasets: [{
            label: 'Cr√≠ticos',
            data: data.stock_critico_marca_values,
            backgroundColor: '#f28e2b',
            borderColor: '#c56e1a',
            borderWidth: 1,
            barThickness: 'flex',
            maxBarThickness: 50,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});
</script>

{% endblock %}
