{% extends 'base.html' %}
{% load static %}

{% block title %}Inicio - DataEasy{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>

</style>
{% endblock %}

{% block content %}

<div class="home-header">
  <h2 class="home-title">Hola, {{ request.user.first_name|default:request.user.username }} üëã</h2>
  <p class="home-subtitle">Resumen general del inventario</p>
</div>

<form method="get" class="filtro-fechas">

    <div>
        <label>Desde</label>
        <input type="date" name="fecha_inicio" value="{{ fecha_inicio|date:'Y-m-d' }}">
    </div>

    <div>
        <label>Hasta</label>
        <input type="date" name="fecha_fin" value="{{ fecha_fin|date:'Y-m-d' }}">
    </div>

    <button type="submit" class="btn btn-primary">Filtrar</button>

    {% if request.GET.fecha_inicio or request.GET.fecha_fin %}
    <a href="{% url 'home' %}" class="btn btn-outline-secondary">‚ùå Limpiar</a>
    {% endif %}

    <div style="margin-left: auto; display: flex; flex-direction: column; align-items: flex-start; padding-left: 15px; border-left: 1px solid #ccc;">
        <label>Vista Dashboard</label>
        <select id="viewSelector" class="form-select" onchange="cambiarDashboard(this.value)">
            <option value="producto" selected>üì¶ Productos</option>
            <option value="categoria">üìÇ Categor√≠as</option>
            <option value="marca">üè∑Ô∏è Marcas</option>
        </select>
    </div>
</form>



<div id="dash-producto" class="dashboard-section">
    
    <section class="stats-summary">
        <div class="stat-card"><h3>Total Productos</h3><div class="value">{{ total_productos }}</div></div>
        <div class="stat-card"><h3>Stock Total</h3><div class="value">{{ stock_total }}</div></div>
        <div class="stat-card"><h3>Sin Stock</h3><div class="value text-danger">{{ productos_sin_stock.count }}</div></div>
        <div class="stat-card"><h3>Bajo Stock</h3><div class="value text-warning">{{ productos_bajo_stock.count }}</div></div>
    </section>

    <div class="charts-grid">
        <div class="chart-container" style="grid-column: span 2;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">Movimientos</h3>
                <select id="rangoSelector" class="form-select form-select-sm" style="width:auto;">
                    <option value="mes" selected>Mensual</option>
                    <option value="semana">Semanal</option>
                    <option value="dia">Diario</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="movimientosMesChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container" style="overflow-y:auto; max-height:400px;">
            <h3>‚ö†Ô∏è Detalle de Alertas</h3>
            <ul style="padding-left:20px; list-style:none;">
                {% for p in productos_sin_stock %}
                    <li style="color:#e74c3c; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                        <strong>üî¥ {{ p.nombre_producto }}</strong><br>
                        <small>Sin stock (M√≠n: {{ p.stock_minimo }})</small>
                    </li>
                {% empty %}
                   {% if not productos_bajo_stock %} <li class="text-muted">Todo en orden ‚úÖ</li> {% endif %}
                {% endfor %}
                
                {% for p in productos_bajo_stock %}
                    <li style="color:#f39c12; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                        <strong>üü° {{ p.nombre_producto }}</strong><br>
                        <small>Stock: {{ p.stock_actual }} / M√≠n: {{ p.stock_minimo }}</small>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>


<div id="dash-categoria" class="dashboard-section" style="display:none;">
    
    <section class="stats-summary" style="grid-template-columns: repeat(1, 1fr);">
        <div class="stat-card" style="border-left: 5px solid #36a2eb;">
            <h3>Total Categor√≠as Activas</h3><div class="value">{{ total_categorias }}</div>
        </div>
    </section>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>Distribuci√≥n de Stock</h3>
            <div class="chart-wrapper">
                <canvas id="stockCategoriaChart"></canvas>
            </div>
        </div>

        <div class="chart-container" style="grid-column: span 2;">
            <h3>Categor√≠as con Stock Cr√≠tico</h3>
            <div class="chart-wrapper">
                <canvas id="criticoCategoriaChart"></canvas>
            </div>
        </div>
    </div>
</div>


<div id="dash-marca" class="dashboard-section" style="display:none;">
    
    <section class="stats-summary" style="grid-template-columns: repeat(1, 1fr);">
        <div class="stat-card" style="border-left: 5px solid #9966ff;">
            <h3>Total Marcas Registradas</h3><div class="value">{{ total_marcas }}</div>
        </div>
    </section>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>Distribuci√≥n por Marca</h3>
            <div class="chart-wrapper">
                <canvas id="stockMarcaChart"></canvas>
            </div>
        </div>

        <div class="chart-container" style="grid-column: span 2;">
            <h3>Marcas con Stock Cr√≠tico</h3>
            <div class="chart-wrapper">
                <canvas id="criticoMarcaChart"></canvas>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===========================================
   1. L√ìGICA DE PESTA√ëAS (DASHBOARDS)
===========================================*/
function cambiarDashboard(vista) {
    document.querySelectorAll('.dashboard-section').forEach(el => el.style.display = 'none');
    const selected = document.getElementById('dash-' + vista);
    if(selected) selected.style.display = 'block';
}

/* ===========================================
   2. DATOS EST√ÅTICOS DESDE DJANGO
===========================================*/
const data = JSON.parse(`{{ chart_data_json|escapejs }}`);


/* ===========================================
   3. GR√ÅFICO DIN√ÅMICO: MOVIMIENTOS (API)
===========================================*/
let movimientosChart = null;

function cargarGraficoMovimientos(rango) {
    const params = new URLSearchParams(window.location.search);
    const fInicio = params.get('fecha_inicio') || '';
    const fFin = params.get('fecha_fin') || '';

    fetch(`/api/chart-data/?rango=${rango}&fecha_inicio=${fInicio}&fecha_fin=${fFin}`)
        .then(response => response.json())
        .then(apiData => {
            const ctx = document.getElementById('movimientosMesChart').getContext('2d');
            
            if (movimientosChart) movimientosChart.destroy();

            movimientosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: apiData.labels,
                    datasets: [
                        { 
                            label: 'Entradas', 
                            data: apiData.entradas, 
                            borderColor: '#4e79a7', 
                            backgroundColor: 'rgba(78, 121, 167, 0.1)',
                            fill: true, tension: 0.3 
                        },
                        { 
                            label: 'Salidas', 
                            data: apiData.salidas, 
                            borderColor: '#e15759', 
                            backgroundColor: 'rgba(225, 87, 89, 0.1)',
                            fill: true, tension: 0.3 
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } }
                }
            });
        })
        .catch(err => console.error("Error cargando gr√°fico din√°mico:", err));
}

document.addEventListener("DOMContentLoaded", () => {
    cargarGraficoMovimientos('mes'); 
    document.getElementById('rangoSelector').addEventListener('change', function() {
        cargarGraficoMovimientos(this.value);
    });
});


/* ===========================================
   4. GR√ÅFICOS EST√ÅTICOS
===========================================*/

/* ===========================================
   DEFINICI√ìN DE PALETA DE COLORES (Global para consistencia)
===========================================*/
const paletaColores = [
    '#4e79a7', // Azul
    '#f28e2b', // Naranja
    '#e15759', // Rojo
    '#76b7b2', // Turquesa
    '#59a14f', // Verde
    '#edc948', // Amarillo
    '#b07aa1', // Lila
    '#ff9da7', // Rosa
    '#9c755f', // Caf√©
    '#bab0ac'  // Gris
];

/* ===========================================
   GR√ÅFICO 1: STOCK POR CATEGOR√çA (PASTEL)
===========================================*/
if(document.getElementById('stockCategoriaChart')) {
    new Chart(document.getElementById('stockCategoriaChart'), {
        type: 'doughnut',
        data: {
            labels: data.stock_por_categoria_labels,
            datasets: [{
                data: data.stock_por_categoria_values,
                backgroundColor: paletaColores, 
                borderWidth: 2
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
}

/* ===========================================
   GR√ÅFICO 2: CR√çTICO POR CATEGOR√çA (BARRAS)
===========================================*/
if(document.getElementById('criticoCategoriaChart')) {
    
    const coloresDinamicos = data.stock_critico_categoria_labels.map(nombreCat => {
        const indiceEnPastel = data.stock_por_categoria_labels.indexOf(nombreCat);
        if (indiceEnPastel >= 0) {
            return paletaColores[indiceEnPastel % paletaColores.length];
        } else {
            return '#cccccc';
        }
    });

    new Chart(document.getElementById('criticoCategoriaChart'), {
        type: 'bar',
        data: {
            labels: data.stock_critico_categoria_labels,
            datasets: [{
                label: 'Productos Cr√≠ticos',
                data: data.stock_critico_categoria_values,
                backgroundColor: coloresDinamicos, 
                barThickness: 'flex', maxBarThickness: 40
            }]
        },
        options: { 
            indexAxis: 'y', 
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,    
                        precision: 0    
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            return data.stock_critico_categoria_tooltips[context[0].dataIndex];
                        }
                    }
                }
            }
        }
    });
}

/* ===========================================
   GR√ÅFICO 4: CR√çTICO POR MARCA (BARRAS)
===========================================*/
if(document.getElementById('criticoMarcaChart')) {
    const coloresMarcaDinamicos = data.stock_critico_marca_labels.map(nombreMarca => {
        const indiceEnPastel = data.stock_por_marca_labels.indexOf(nombreMarca);
        if (indiceEnPastel >= 0) {
            return paletaColores[indiceEnPastel % paletaColores.length];
        } else {
            return '#cccccc';
        }
    });

    new Chart(document.getElementById('criticoMarcaChart'), {
        type: 'bar',
        data: {
            labels: data.stock_critico_marca_labels,
            datasets: [{
                label: 'Productos Cr√≠ticos',
                data: data.stock_critico_marca_values,
                backgroundColor: coloresMarcaDinamicos,
                barThickness: 'flex', maxBarThickness: 50
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                y: {  
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,    
                        precision: 0    
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            return data.stock_critico_marca_tooltips[context[0].dataIndex];
                        }
                    }
                }
            }
        }
    });
}

/* ===========================================
   GR√ÅFICO 3: STOCK POR MARCA (PASTEL)
===========================================*/
if(document.getElementById('stockMarcaChart')) {
    new Chart(document.getElementById('stockMarcaChart'), {
        type: 'doughnut',
        data: {
            labels: data.stock_por_marca_labels,
            datasets: [{
                data: data.stock_por_marca_values,
                backgroundColor: paletaColores, 
                borderWidth: 2
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
}

</script>
{% endblock %}