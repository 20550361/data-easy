{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home - DataEasy</title>
  <link rel="stylesheet" href="{% static 'css/home-style.css' %}">
</head>
<body>

  <!-- ===== BARRA SUPERIOR ===== -->
  <header class="topbar">
    <h1 class="logo">DataEasy</h1>
    <div class="user-menu-wrapper">
      <img src="{% static 'img/user.png' %}" alt="Usuario" class="user-icon" id="userIcon">
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="{% url 'configuracion' %}">âš™ï¸ ConfiguraciÃ³n</a>
        <a href="{% url 'logout' %}">ğŸ”’ Cerrar sesiÃ³n</a>
      </div>
    </div>
  </header>

  <!-- ===== CONTENIDO PRINCIPAL (Perfil) ===== -->
  <main class="content">
    <div class="profile-card" id="profileCard">
      <img src="{% static 'img/user.png' %}" alt="Foto de usuario" class="profile-avatar">
      <h2 id="displayUsername">{{ user.username }}</h2>
      <p class="profile-subtitle">Usuario de DataEasy</p>

      <div class="profile-info" id="displayInfo">
        <p><strong>Correo:</strong> <span id="displayEmail">{{ user.email|default:"No registrado" }}</span></p>
        <p><strong>NÃºmero:</strong> <span id="displayPhone">+56 9 0000 0000</span></p>
      </div>

      <div class="profile-edit hidden" id="editInfo">
        <label for="emailInput">Correo</label>
        <input type="email" id="emailInput" placeholder="Ingresa tu correo">

        <label for="phoneInput">NÃºmero</label>
        <input type="text" id="phoneInput" placeholder="+56 9 0000 0000">

        <div class="actions">
          <button class="save-btn" id="saveBtn" type="button">Guardar</button>
          <button class="cancel-btn" id="cancelBtn" type="button">Cancelar</button>
        </div>
      </div>

      <button class="edit-btn" id="editToggleBtn" type="button">âœï¸ Editar informaciÃ³n</button>
      <p class="note">* Cambios guardados localmente en este navegador.</p>
    </div>
  </main>

  <script>
    // === MENÃš DESPLEGABLE ===
    const userIcon = document.getElementById('userIcon');
    const dropdownMenu = document.getElementById('dropdownMenu');
    document.addEventListener('click', (e) => {
      if (userIcon.contains(e.target)) {
        dropdownMenu.classList.toggle('show');
      } else if (!dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });

    // === LÃ“GICA DE EDICIÃ“N LOCAL ===
    const username = "{{ user.username|escapejs }}";
    const keyEmail = `profile_email_${username}`;
    const keyPhone = `profile_phone_${username}`;
    const displayEmail = document.getElementById('displayEmail');
    const displayPhone = document.getElementById('displayPhone');
    const displayInfo  = document.getElementById('displayInfo');
    const editInfo     = document.getElementById('editInfo');
    const emailInput   = document.getElementById('emailInput');
    const phoneInput   = document.getElementById('phoneInput');
    const editToggleBtn = document.getElementById('editToggleBtn');
    const saveBtn       = document.getElementById('saveBtn');
    const cancelBtn     = document.getElementById('cancelBtn');

    function loadLocal() {
      const savedEmail = localStorage.getItem(keyEmail);
      const savedPhone = localStorage.getItem(keyPhone);
      if (savedEmail) displayEmail.textContent = savedEmail;
      if (savedPhone) displayPhone.textContent = savedPhone;
    }

    function enterEdit() {
      emailInput.value = displayEmail.textContent.trim();
      phoneInput.value = displayPhone.textContent.trim();
      displayInfo.classList.add('hidden');
      editInfo.classList.remove('hidden');
      editToggleBtn.classList.add('hidden');
    }

    function exitEdit() {
      editInfo.classList.add('hidden');
      displayInfo.classList.remove('hidden');
      editToggleBtn.classList.remove('hidden');
    }

    function saveChanges() {
      const newEmail = (emailInput.value || '').trim();
      const newPhone = (phoneInput.value || '').trim();
      localStorage.setItem(keyEmail, newEmail || '');
      localStorage.setItem(keyPhone, newPhone || '');
      displayEmail.textContent = newEmail || 'No registrado';
      displayPhone.textContent = newPhone || '+56 9 0000 0000';
      exitEdit();
      const card = document.getElementById('profileCard');
      card.classList.add('pulse');
      setTimeout(()=> card.classList.remove('pulse'), 400);
    }

    document.addEventListener('DOMContentLoaded', loadLocal);
    editToggleBtn.addEventListener('click', enterEdit);
    saveBtn.addEventListener('click', saveChanges);
    cancelBtn.addEventListener('click', exitEdit);
  </script>
</body>
</html>
