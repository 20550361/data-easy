{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - DataEasy{% endblock %}
{% block styles %}
  <style>
    .form-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .field { margin:10px 0; display:flex; flex-direction:column; gap:6px; }
    input[type="text"], input[type="email"], input[type="password"] {
      padding:10px; border:1px solid #ddd; border-radius:8px;
    }
    .btn-primary { background:#2C3E50; color:#fff; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; }
    .btn-secondary { padding:10px 16px; border:1px solid #ccc; border-radius:8px; margin-left:8px; text-decoration:none; }
    .errorlist { color:#b00020; margin-top:10px; }
  </style>
{% endblock %}

{% block content %}
  <h2>游논 {{ titulo }}</h2>

  <!-- Agregamos ID al formulario para validarlo con JS -->
  <form method="post" class="form-vertical" id="userForm">
    {% csrf_token %}
    <div class="form-grid">

      {# Campos principales #}
      <div class="card">
        <h3>Datos b치sicos</h3>
        <div class="field">{{ form.username.label_tag }} {{ form.username }}</div>
        <div class="field">{{ form.email.label_tag }} {{ form.email }}</div>
        <div class="field">{{ form.first_name.label_tag }} {{ form.first_name }}</div>
        <div class="field">{{ form.last_name.label_tag }} {{ form.last_name }}</div>
      </div>

      {# Contrase침a (solo crear) #}
      {% if form.password1 %}
      <div class="card">
        <h3>Contrase침a</h3>
        <div class="field">{{ form.password1.label_tag }} {{ form.password1 }}</div>
        <div class="field">{{ form.password2.label_tag }} {{ form.password2 }}</div>
      </div>
      {% endif %}

      {# Cambiar contrase침a (editar) #}
      {% if form.new_password1 %}
      <div class="card">
        <h3>Cambiar contrase침a</h3>
        <div class="field">{{ form.new_password1.label_tag }} {{ form.new_password1 }}</div>
        <div class="field">{{ form.new_password2.label_tag }} {{ form.new_password2 }}</div>
      </div>
      {% endif %}

      <div class="card">
        <h3>Permisos</h3>
        <div class="field">{{ form.is_active }} {{ form.is_active.label_tag }}</div>
        <div class="field">{{ form.is_staff }} {{ form.is_staff.label_tag }}</div>
        {# Si habilitas superusuario en forms, mu칠stralo aqu칤 #}
        {# <div class="field">{{ form.is_superuser }} {{ form.is_superuser.label_tag }}</div> #}
      </div>

      
      </div>

    </div>

    {% if form.errors %}
      <div class="errorlist">
        {{ form.errors }}
      </div>
    {% endif %}

    <div class="toolbar" style="margin-top:16px;">
      <button type="submit" class="btn-primary">
        {% if modo == 'crear' %}Crear usuario{% else %}Guardar cambios{% endif %}
      </button>
      <a href="{% url 'lista_usuarios' %}" class="btn-secondary">Cancelar</a>
    </div>
  </form>

<!-- ========================================== -->
<!-- MODAL DE VALIDACI칍N DE PERMISOS (POP-UP) -->
<!-- ========================================== -->
<div class="modal fade" id="permisosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">丘멆잺 Validaci칩n requerida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="fw-bold">El usuario debe ser ACTIVO o STAFF.</p>
        <p class="mb-0">Por favor, selecciona al menos una de estas opciones para continuar.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<!-- Script de validaci칩n Cliente -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("userForm");
    
    // Los IDs de los checkboxes son generados autom치ticamente por Django como id_nombrecampo
    const isActiveCheckbox = document.getElementById("id_is_active");
    const isStaffCheckbox = document.getElementById("id_is_staff");
    
    // Inicializar el modal de Bootstrap
    const permisosModal = new bootstrap.Modal(document.getElementById("permisosModal"));

    if (form && isActiveCheckbox && isStaffCheckbox) {
        form.addEventListener("submit", function(e) {
            // Verificar si AMBOS est치n desmarcados
            if (!isActiveCheckbox.checked && !isStaffCheckbox.checked) {
                e.preventDefault(); // Detener el env칤o del formulario
                permisosModal.show(); // Mostrar el pop-up
            }
        });
    }
});
</script>

{% endblock %}